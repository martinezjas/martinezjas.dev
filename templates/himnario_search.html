{% extends 'base.html' %}
{% block style %}
<style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
  }
  body {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header, footer {
    flex-shrink: 0;
  }
  main.himnario-main {
    flex: 1 0 auto;
    min-height: 0;
    background-image: url("/static/images/background.jpg");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    box-shadow: inset 0 0 0 2000px rgba(0, 0, 0, 0.588);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 100vw;
  }
  img {
    max-width: 100%;
    height: auto;
  }

  .autocomplete-dropdown {
    position: absolute;
    z-index: 1000;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    margin-top: 0.25rem;
    max-height: 300px;
    overflow-y: auto;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  }

  .autocomplete-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #f3f4f6;
  }

  .autocomplete-item:hover,
  .autocomplete-item.selected {
    background-color: #f3f4f6;
  }

  .autocomplete-item:last-child {
    border-bottom: none;
  }

  .autocomplete-number {
    font-weight: bold;
    color: #374151;
  }

  .autocomplete-title {
    color: #6b7280;
    font-size: 0.875rem;
  }
</style>
{% endblock %}
{% block content %}
<main class="w-full himnario-main font-lora">
  <div class="flex items-center justify-center w-full h-full">
    <div class="flex flex-wrap items-center">
      <div class="flex flex-col">
        <h1 class="mb-2 text-5xl text-white">
          <i class="bi bi-music-note-list"></i>
          <span>Himnario Adventista Applet</span>
        </h1>
        <p class="mt-2 mb-8 text-lg text-white">
          This application is based off of
          <a
            class="underline hover:text-slate-300"
            href="https://github.com/jhormanrus/himnario-adventista-api"
            >Jhorman Russuel's Himnario Adventista API</a
          >.
        </p>
        <form method="post" class="flex flex-row mb-5" id="himnarioForm">
          {{form.csrf_token}}
          <div class="mr-8 relative">
            {{form.number.label(class="block mb-2 mr-5 text-3xl font-bold text-white")}}
            {{form.number(class="w-full px-4 py-2 mr-5 text-black border border-gray-400 rounded-lg", id="numberInput", autocomplete="off")}}
            <div id="autocompleteDropdown" class="autocomplete-dropdown" style="display: none; width: calc(100% - 1.25rem);"></div>
          </div>
          <div class="text-white">
            {{form.option.label(class="block mb-2 text-3xl font-bold -lg")}}
            {{form.option(class="inline-block text-xl align-middle")}}
          </div>
        </form>
        <div class="flex flex-row flex-wrap">
          <a
            id="button"
            href="/hdoc"
            role="button"
            class="inline-block px-2 py-2 mr-4 text-white bg-gray-500 rounded-lg hover:bg-gray-600 focus:bg-gray-600"
          >
            Go to Documentation / Ir a documentaci√≥n
          </a>
          <a
            id="button"
            href="{{url_for('static', filename='himnario.pdf')}}"
            target="_new"
            role="button"
            class="inline-block px-2 py-2 mx-4 text-white bg-gray-500 rounded-lg hover:bg-gray-600 focus:bg-gray-600"
          >
            PDF Copy of Hymnary / Copia PDF del Himnario
          </a>
          <a
            id="button"
            href="https://forms.gle/Jp8eKBc47rT5FUqaA"
            target="_new"
            role="button"
            class="inline-block px-2 py-2 mx-4 text-white bg-gray-500 rounded-lg hover:bg-gray-600 focus:bg-gray-600"
          >
            Feedback / Comentarios
          </a>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  (function() {
    const numberInput = document.getElementById('numberInput');
    const dropdown = document.getElementById('autocompleteDropdown');
    const form = document.getElementById('himnarioForm');
    let debounceTimer;
    let selectedIndex = -1;
    let results = [];

    // Debounced search function
    function performSearch(query) {
      if (!query || query.length < 1) {
        hideDropdown();
        return;
      }

      fetch(`/api/search/autocomplete?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          results = data;
          displayResults(data);
        })
        .catch(error => {
          console.error('Search error:', error);
          hideDropdown();
        });
    }

    // Display autocomplete results
    function displayResults(data) {
      if (!data || data.length === 0) {
        hideDropdown();
        return;
      }

      dropdown.innerHTML = '';
      selectedIndex = -1;

      data.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'autocomplete-item';
        div.innerHTML = `
          <div class="autocomplete-number">Himno ${item.number}</div>
          <div class="autocomplete-title">${item.title}</div>
        `;
        div.dataset.number = item.number;
        div.dataset.index = index;

        div.addEventListener('click', () => selectHymn(item.number));
        dropdown.appendChild(div);
      });

      dropdown.style.display = 'block';
    }

    // Hide dropdown
    function hideDropdown() {
      dropdown.style.display = 'none';
      selectedIndex = -1;
    }

    // Select hymn and set value
    function selectHymn(number) {
      numberInput.value = number;
      hideDropdown();
    }

    // Keyboard navigation
    function handleKeydown(e) {
      const items = dropdown.querySelectorAll('.autocomplete-item');

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (selectedIndex < items.length - 1) {
          selectedIndex++;
          updateSelection(items);
        }
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (selectedIndex > 0) {
          selectedIndex--;
          updateSelection(items);
        }
      } else if (e.key === 'Enter') {
        if (selectedIndex >= 0 && items[selectedIndex]) {
          e.preventDefault();
          const number = items[selectedIndex].dataset.number;
          selectHymn(number);
        }
      } else if (e.key === 'Escape') {
        hideDropdown();
      }
    }

    // Update visual selection
    function updateSelection(items) {
      items.forEach((item, index) => {
        if (index === selectedIndex) {
          item.classList.add('selected');
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.classList.remove('selected');
        }
      });
    }

    // Event listeners
    numberInput.addEventListener('input', (e) => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        performSearch(e.target.value);
      }, 300);
    });

    numberInput.addEventListener('keydown', handleKeydown);

    // Click outside to close
    document.addEventListener('click', (e) => {
      if (!numberInput.contains(e.target) && !dropdown.contains(e.target)) {
        hideDropdown();
      }
    });
  })();
</script>
{% endblock %}